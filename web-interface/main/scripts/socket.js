// this file relies on statuses.js to exist before itself
let meshTelUploading = false;
const meshTelData = `mtel_starttilt-up-2|17765,0.00,3.54,19.53,0.00|17792,1.00,4.15,19.21,0.00|17819,2.00,-1.53,18.43,0.00|17846,3.00,2.26,18.74,0.00|17873,4.00,12.45,18.98,0.00|17900,5.00,25.70,18.82,0.00|
17927,6.00,15.93,19.09,0.00|17954,7.00,18.62,18.94,0.00|17981,8.00,28.93,19.45,0.00|18008,9.00,41.32,19.37,0.00|18035,10.00,22.46,19.76,0.00|18062,11.00,6.53,19.57,0.00|
18089,12.00,11.60,20.08,0.00|18116,13.00,21.24,20.47,0.00|18144,14.00,29.85,19.76,0.00|18171,15.00,30.03,20.43,0.00|18198,16.00,28.44,20.24,0.00|18225,17.00,11.05,22.64,0.00|
18252,18.00,28.14,21.02,0.00|18279,19.00,35.16,20.35,0.00|18306,20.00,31.62,21.34,0.00|18333,21.00,34.67,22.36,0.00|18360,22.00,17.09,21.89,0.00|18387,23.00,22.64,22.40,0.00|
18414,24.00,21.97,20.35,0.00|18441,25.00,21.85,22.87,0.00|18468,26.00,27.22,20.75,0.00|18495,27.00,16.42,21.65,0.00|18522,28.00,19.17,21.46,0.00|18550,29.00,23.44,47.00,0.00|
18577,0.00,25.21,47.00,0.00|18604,1.00,10.13,47.00,0.00|18631,2.00,17.40,47.00,0.00|18658,3.00,11.54,17.44,0.00|18685,4.00,-8.61,24.92,0.00|18712,5.00,-15.26,47.00,0.00|
18739,6.00,-24.90,22.44,0.00|18766,7.00,-8.18,16.85,0.00|18793,8.00,-20.14,23.15,0.00|18820,9.00,-29.11,23.62,0.00|18847,10.00,-11.41,22.24,0.00|18874,11.00,-13.37,23.31,0.00|
18901,12.00,-23.62,22.01,0.00|18928,13.00,-22.46,20.28,0.00|18956,14.00,-30.46,22.24,0.00|18983,15.00,-19.53,20.00,0.00|19010,16.00,-20.69,20.43,0.00|19037,17.00,-23.87,21.38,0.00|
19064,18.00,-24.72,20.91,0.00|19091,19.00,-22.71,20.00,0.00|19118,20.00,-16.24,20.55,0.00|19145,21.00,-16.60,20.16,0.00|19172,22.00,-18.92,19.45,0.00|19199,23.00,-28.20,19.92,0.00|
19226,24.00,-18.98,20.43,0.00|19253,25.00,-19.96,18.58,0.00|19280,26.00,-26.61,18.35,0.00|19307,27.00,-15.44,19.45,0.00|19335,28.00,-23.93,19.25,0.00|19362,29.00,-30.27,19.57,0.00|
19389,0.00,-22.22,18.39,0.00|19416,1.00,-12.45,18.19,0.00|19443,2.00,-11.84,19.37,0.00|19470,3.00,-20.14,18.58,0.00|19497,4.00,-26.73,18.98,0.00|19524,5.00,-24.66,18.50,0.00|
19551,6.00,-23.32,18.50,0.00|19578,7.00,-20.20,19.29,0.00|19605,8.00,-16.54,17.32,0.00|19632,9.00,-27.95,18.31,0.00|19659,10.00,-23.87,18.54,0.00|19686,11.00,-18.86,18.07,0.00|
19713,12.00,-25.76,18.31,0.00|19741,13.00,-24.54,18.03,0.00|19768,14.00,-19.90,18.46,0.00|19795,15.00,-30.33,18.23,0.00|19822,16.00,-33.51,18.39,0.00|19849,17.00,-8.24,18.43,0.00|
19876,18.00,-16.66,18.27,0.00|19903,19.00,-25.51,17.72,0.00|19930,20.00,-20.81,18.15,0.00|19957,21.00,-26.67,18.23,0.00|19984,22.00,-26.86,18.54,0.00|20011,23.00,-18.01,18.66,0.00|
20038,24.00,-9.89,18.27,0.00|20065,25.00,-26.31,18.39,0.00|20092,26.00,-22.71,18.31,0.00|20119,27.00,-29.97,18.23,0.00|20147,28.00,-30.03,18.43,0.00|20174,29.00,-13.86,17.83,0.00|tilt-up-1|
21301,0.00,1.65,17.72,0.00|21328,1.00,-0.73,17.80,0.00|21355,2.00,-6.96,18.27,0.00|21382,3.00,9.89,17.56,0.00|21409,4.00,9.40,18.15,0.00|21436,5.00,8.55,18.15,0.00|
21463,6.00,13.92,17.60,0.00|21490,7.00,11.60,17.56,0.00|21517,8.00,8.00,18.23,0.00|21544,9.00,22.71,17.95,0.00|21571,10.00,15.38,17.64,0.00|21599,11.00,12.88,17.87,0.00|
21626,12.00,28.81,18.19,0.00|21653,13.00,32.78,17.40,0.00|21680,14.00,33.39,17.91,0.00|21707,15.00,20.39,17.95,0.00|21734,16.00,20.81,17.52,0.00|21761,17.00,13.49,18.23,0.00|
21788,18.00,8.55,17.91,0.00|21815,19.00,29.97,17.56,0.00|21842,20.00,26.55,17.76,0.00|21869,21.00,12.39,17.83,0.00|21896,22.00,16.17,18.46,0.00|21923,23.00,25.64,17.52,0.00|
21950,24.00,24.11,18.11,0.00|21977,25.00,18.19,17.56,0.00|22005,26.00,23.13,17.87,0.00|22032,27.00,21.79,17.64,0.00|22059,28.00,31.98,18.23,0.00|22086,29.00,10.25,18.86,0.00|
22113,0.00,13.24,18.23,0.00|22140,1.00,30.21,18.43,0.00|22167,2.00,-0.61,17.68,0.00|22194,3.00,3.30,18.43,0.00|22221,4.00,32.17,18.58,0.00|22248,5.00,19.84,18.23,0.00|
22275,6.00,19.23,18.66,0.00|22302,7.00,18.31,18.66,0.00|22329,8.00,27.47,20.12,0.00|22356,9.00,27.89,19.45,0.00|22383,10.00,14.77,18.90,0.00|22411,11.00,13.49,19.69,0.00|
22438,12.00,22.89,19.49,0.00|22465,13.00,18.98,19.29,0.00|22492,14.00,16.24,20.63,0.00|22519,15.00,21.85,20.91,0.00|22546,16.00,23.13,20.00,0.00|22573,17.00,21.79,20.24,0.00|
22600,18.00,34.85,20.59,0.00|22627,19.00,20.45,21.69,0.00|22654,20.00,15.63,21.89,0.00|22681,21.00,23.25,22.56,0.00|22708,22.00,28.50,22.48,0.00|22735,23.00,17.76,23.35,0.00|
22762,24.00,25.76,23.19,0.00|22790,25.00,18.31,23.66,0.00|22817,26.00,16.97,22.36,0.00|22844,27.00,27.77,21.57,0.00|22871,28.00,27.28,21.85,0.00|22898,29.00,13.06,22.83,0.00|middle|
24005,0.00,-4.46,22.95,0.00|24032,1.00,0.31,22.52,0.00|24059,2.00,-2.99,21.65,0.00|24086,3.00,2.26,22.44,0.00|24113,4.00,-15.38,22.05,0.00|24140,5.00,-17.46,23.54,0.00|
24167,6.00,-20.20,21.81,0.00|24194,7.00,-22.83,22.95,0.00|24221,8.00,-18.19,22.52,0.00|24249,9.00,-14.95,23.15,0.00|24276,10.00,-22.95,22.87,0.00|24303,11.00,-16.91,22.76,0.00|
24330,12.00,-18.25,23.94,0.00|24357,13.00,-10.86,22.76,0.00|24384,14.00,-15.38,22.72,0.00|24411,15.00,-16.66,22.17,0.00|24438,16.00,-25.57,22.64,0.00|24465,17.00,-30.76,23.11,0.00|
24492,18.00,-32.41,23.03,0.00|24519,19.00,-28.56,22.01,0.00|24546,20.00,-20.69,22.05,0.00|24573,21.00,-33.45,21.57,0.00|24600,22.00,-22.77,19.80,0.00|24627,23.00,-17.94,20.24,0.00|
24655,24.00,-15.93,21.18,0.00|24682,25.00,-10.13,19.80,0.00|24709,26.00,-18.49,21.18,0.00|24736,27.00,-6.23,18.39,0.00|24763,28.00,-28.44,19.17,0.00|24790,29.00,-24.48,17.40,0.00|
24817,0.00,-26.49,18.15,0.00|24844,1.00,-28.32,17.64,0.00|24871,2.00,-16.17,17.72,0.00|24898,3.00,-11.78,17.64,0.00|24925,4.00,-13.73,18.15,0.00|24952,5.00,-16.30,17.60,0.00|
24979,6.00,-15.93,17.52,0.00|25006,7.00,-17.52,17.28,0.00|25034,8.00,-20.08,17.13,0.00|25061,9.00,-21.30,17.24,0.00|25088,10.00,-17.15,16.85,0.00|25115,11.00,-16.91,16.97,0.00|
25142,12.00,-28.02,17.40,0.00|25169,13.00,-25.15,17.13,0.00|25196,14.00,-29.11,17.01,0.00|25223,15.00,-20.69,16.77,0.00|25250,16.00,-25.39,16.81,0.00|25277,17.00,-26.06,16.97,0.00|
25304,18.00,-29.66,17.40,0.00|25331,19.00,-27.71,16.65,0.00|25358,20.00,-18.49,16.69,0.00|25385,21.00,-14.77,16.93,0.00|25412,22.00,-17.52,17.52,0.00|25440,23.00,-18.62,17.32,0.00|
25467,24.00,-16.24,16.73,0.00|25494,25.00,-16.60,16.73,0.00|25521,26.00,-26.67,17.44,0.00|25548,27.00,-20.45,16.85,0.00|25575,28.00,-21.97,16.65,0.00|25602,29.00,-19.59,17.24,0.00|
25629,0.00,-18.49,16.89,0.00|25656,1.00,-18.86,17.20,0.00|25683,2.00,-9.16,17.09,0.00|25710,3.00,3.17,17.72,0.00|25737,4.00,7.57,17.09,0.00|25764,5.00,12.57,16.38,0.00|
25791,6.00,27.16,16.97,0.00|25818,7.00,17.64,17.13,0.00|25846,8.00,2.50,17.09,0.00|25873,9.00,12.15,16.85,0.00|25900,10.00,36.07,16.93,0.00|25927,11.00,26.06,17.20,0.00|
25954,12.00,15.93,16.89,0.00|25981,13.00,38.57,17.17,0.00|26008,14.00,39.12,17.05,0.00|26035,15.00,18.55,17.09,0.00|26062,16.00,-0.55,16.69,0.00|26089,17.00,25.51,17.24,0.00|
26116,18.00,39.73,17.05,0.00|26143,19.00,23.32,17.01,0.00|26170,20.00,7.69,16.85,0.00|26197,21.00,27.28,16.81,0.00|26225,22.00,28.20,17.01,0.00|26252,23.00,31.37,17.01,0.00|
26279,24.00,18.74,16.38,0.00|26306,25.00,34.79,16.65,0.00|26333,26.00,45.78,17.20,0.00|26360,27.00,24.17,17.36,0.00|26387,28.00,23.01,17.91,0.00|26414,29.00,28.81,17.36,0.00|tilt-down-1|
27521,0.00,0.61,19.41,0.00|27548,1.00,0.98,19.57,0.00|27575,2.00,11.11,18.70,0.00|27602,3.00,9.64,19.13,0.00|27629,4.00,23.62,19.02,0.00|27656,5.00,2.93,19.37,0.00|
27684,6.00,10.50,19.41,0.00|27711,7.00,15.50,19.41,0.00|27738,8.00,28.26,19.06,0.00|27765,9.00,32.84,22.05,0.00|27792,10.00,25.94,21.06,0.00|27819,11.00,21.73,23.07,0.00|
27846,12.00,18.07,21.73,0.00|27873,13.00,30.21,22.83,0.00|27900,14.00,18.62,22.20,0.00|27927,15.00,24.72,20.31,0.00|27954,16.00,28.87,21.89,0.00|27981,17.00,15.81,21.54,0.00|
28008,18.00,20.63,21.38,0.00|28035,19.00,22.52,22.32,0.00|28062,20.00,31.31,22.99,0.00|28090,21.00,21.12,20.94,0.00|28117,22.00,20.57,21.57,0.00|28144,23.00,23.99,19.61,0.00|
28171,24.00,18.55,22.05,0.00|28198,25.00,14.28,21.89,0.00|28225,26.00,17.64,22.32,0.00|28252,27.00,24.11,18.27,0.00|28279,28.00,19.84,21.46,0.00|28306,29.00,33.02,21.61,0.00|
28333,0.00,17.70,21.22,0.00|28360,1.00,19.90,21.54,0.00|28387,2.00,14.59,20.35,0.00|28414,3.00,0.37,20.83,0.00|28441,4.00,-7.39,21.65,0.00|28469,5.00,-15.69,22.05,0.00|
28496,6.00,-19.23,20.98,0.00|28523,7.00,-16.85,22.05,0.00|28550,8.00,-15.08,20.67,0.00|28577,9.00,-24.41,19.13,0.00|28604,10.00,-42.24,22.99,0.00|28631,11.00,-25.39,24.17,0.00|
28658,12.00,-16.36,20.91,0.00|28685,13.00,-20.57,21.38,0.00|28712,14.00,-14.22,20.98,0.00|28739,15.00,-15.20,22.32,0.00|28766,16.00,-29.48,22.56,0.00|28793,17.00,-28.69,22.20,0.00|
28820,18.00,-23.32,22.64,0.00|28847,19.00,-30.82,21.93,0.00|28875,20.00,-39.25,22.32,0.00|28902,21.00,-14.04,24.02,0.00|28929,22.00,-13.31,20.79,0.00|28956,23.00,-46.33,20.87,0.00|
28983,24.00,-26.37,20.35,0.00|29010,25.00,-4.21,20.08,0.00|29037,26.00,-14.34,21.61,0.00|29064,27.00,-19.53,19.76,0.00|29091,28.00,-13.86,19.21,0.00|29118,29.00,-36.74,20.75,0.00|
29145,0.00,-39.25,18.62,0.00|29172,1.00,-24.41,18.98,0.00|29199,2.00,-14.16,18.54,0.00|29226,3.00,-3.78,18.11,0.00|29253,4.00,-10.80,18.82,0.00|29281,5.00,-16.48,18.58,0.00|
29308,6.00,-12.45,17.01,0.00|29335,7.00,-20.45,18.27,0.00|29362,8.00,-10.50,17.68,0.00|29389,9.00,-8.42,17.36,0.00|29416,10.00,-6.71,18.94,0.00|29443,11.00,-6.29,17.24,0.00|
29470,12.00,-24.54,17.83,0.00|29497,13.00,-21.00,17.09,0.00|29524,14.00,-18.68,18.11,0.00|29551,15.00,-22.03,17.44,0.00|29578,16.00,-28.56,16.85,0.00|29605,17.00,-20.14,17.44,0.00|
29632,18.00,-16.24,17.17,0.00|29660,19.00,-27.77,17.09,0.00|29687,20.00,-30.33,16.73,0.00|29714,21.00,-22.64,17.17,0.00|29741,22.00,-18.37,17.56,0.00|29768,23.00,-19.96,16.73,0.00|
29795,24.00,-26.73,16.65,0.00|29822,25.00,-23.93,17.68,0.00|29849,26.00,-21.79,16.89,0.00|29876,27.00,-23.68,17.28,0.00|29903,28.00,-0.73,17.13,0.00|29930,29.00,0.24,16.97,0.00|tilt-down-2|
31077,0.00,1.04,17.17,0.00|31104,1.00,0.85,16.69,0.00|31131,2.00,-4.09,16.57,0.00|31159,3.00,3.97,17.44,0.00|31186,4.00,7.20,17.09,0.00|31213,5.00,11.96,16.54,0.00|
31240,6.00,32.10,16.97,0.00|31267,7.00,14.04,17.01,0.00|31294,8.00,18.74,16.54,0.00|31321,9.00,19.29,16.73,0.00|31348,10.00,37.78,16.65,0.00|31375,11.00,10.50,17.17,0.00|
31402,12.00,23.74,17.28,0.00|31429,13.00,37.23,16.81,0.00|31456,14.00,19.10,17.40,0.00|31483,15.00,23.93,16.85,0.00|31510,16.00,13.43,17.17,0.00|31538,17.00,16.36,17.32,0.00|
31565,18.00,27.34,17.17,0.00|31592,19.00,35.16,17.13,0.00|31619,20.00,10.99,17.09,0.00|31646,21.00,25.82,17.76,0.00|31673,22.00,26.00,17.48,0.00|31700,23.00,17.33,17.83,0.00|
31727,24.00,19.35,17.09,0.00|31754,25.00,41.44,17.48,0.00|31781,26.00,19.84,17.68,0.00|31808,27.00,16.11,18.07,0.00|31835,28.00,16.72,17.83,0.00|31862,29.00,31.43,17.44,0.00|
31889,0.00,39.92,17.56,0.00|31916,1.00,-0.98,18.31,0.00|31944,2.00,21.48,18.23,0.00|31971,3.00,15.20,18.03,0.00|31998,4.00,10.62,17.83,0.00|32025,5.00,24.29,17.48,0.00|
32052,6.00,27.89,18.66,0.00|32079,7.00,2.50,17.91,0.00|32106,8.00,6.23,17.95,0.00|32133,9.00,30.58,18.15,0.00|32160,10.00,21.06,18.46,0.00|32187,11.00,21.48,18.35,0.00|
32214,12.00,14.77,18.98,0.00|32241,13.00,26.43,18.27,0.00|32268,14.00,25.88,18.23,0.00|32295,15.00,20.45,18.46,0.00|32323,16.00,18.07,17.95,0.00|32350,17.00,12.02,17.60,0.00|
32377,18.00,36.19,16.85,0.00|32404,19.00,30.03,18.50,0.00|32431,20.00,20.75,18.74,0.00|32458,21.00,31.98,18.31,0.00|32485,22.00,27.34,18.78,0.00|32512,23.00,11.47,18.46,0.00|
32539,24.00,30.58,18.54,0.00|32566,25.00,31.43,18.15,0.00|32593,26.00,14.16,17.95,0.00|32620,27.00,21.55,18.62,0.00|32647,28.00,32.78,18.15,0.00|32674,29.00,10.93,18.94,0.00|mtel_end
`;

meshPlot(meshTelData);

const connectToRobot = () => {
  const socket = new WebSocket('ws://192.168.1.187:80'); // esp01 on robot

  // connection opened, send messages to robot
  socket.addEventListener('open', function (event) {
    socket.send('Hello robot!');
    sentMsg('Hello robot!');
    setRobotConnected(true);
 
    // keep connection to esp01 alive
    setInterval(() => {
      if (!meshTelUploading) {
        socket.send('poll');
        sentMsg('poll');
      }
    }, 1000);
 });
 
 // listen for messages from robot
 socket.addEventListener('message', function (event) {
  console.log('msg received');
  const robotMsg = event.data;

  if (robotMsg === 'mtel_start') {
    meshTelUploading = true;

    // fallback unset
    setTimeout(() => {
      if (meshTelUploading) meshTelUploading = false;
    }, 60000);
  }

  if (robotMsg === 'mtel_end') {
    meshTelUploading = true;
  }

  receivedMsg(robotMsg);
 
  batteryVoltage(robotMsg);
  upsideDown(robotMsg);
 });
 
 socket.addEventListener('close', function (event) {
  console.log('reconnect');
  connectToRobot();
 });
}

connectToRobot();